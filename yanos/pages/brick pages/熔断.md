tag:: #构建高可用微服务 #负载均衡和熔断

- >本文介绍了微服务架构中熔断的重要性以及相关的技术实践和面试准备建议。作者从熔断的基本定义出发，探讨了如何判断微服务出现问题以及如何判断微服务恢复正常的方法。文章提到了熔断策略中需要考虑的阈值选择、持续时间和恢复策略，以及如何避免抖动问题。此外，还提供了面试准备建议，包括公司的熔断实践情况和面试策略。在技术实践方面，作者分享了两种熔断方案，分别基于响应时间和缓存崩溃。另外，还介绍了一个结合负载均衡和熔断的方案，强调了客户端控制流量的重要性。总的来说，本文以技术实践和面试准备为主线，为读者提供了全面的熔断知识和面试策略，适合想要深入了解微服务架构熔断机制的读者。
- ![捕获.PNG](../assets/捕获_1711294077040_0.PNG){:height 337, :width 323}
- 熔断可以给服务端恢复的机会。试想这么一个场景，CPU 使用率已经 100% 了，服务端因此触发了熔断。那么拒绝了新来的请求之后，服务端的 CPU 使用率就会在一段时间内降到 100% 以内。
- **判定服务的健康状态**
	- 一般可以考虑使用响应时间、错误率。不管选择什么指标，都要考虑两个因素：一是阈值如何选择；二是超过阈值之后，要不要持续一段时间才触发熔断。
	- 响应时间一旦超过了阈值就立刻熔断呢？一般也不是，而是要求响应时间超过一段时间之后才触发熔断。这主要是出于两个考虑，一个是响应时间可能是偶发性地突然增长；另外一个则是防止抖动。
- **本身熔断是高并发引起的**。那么在一分钟后，并发依旧很高，这时候**你一旦直接恢复正常，然后高并发的流量打过来，服务是不是又会触发熔断？**
	- 而要解决这个抖动问题，就需要在恢复之后控制住流量。比如说按照 10%、20%、30%……逐步递增，而不是立刻恢复 100% 的流量。
	- 服务端触发熔断之后，客户端就直接不再请求这个节点了，而是换一个节点。等到恢复了之后，客户端再逐步对这个节点放开流量。
- **你是如何使用熔断的？**
	- 这是一个高可用的微服务系统，为了保证它的可用性，我采取了限流、降级、熔断等措施。为了保障微服务的可用性，我在我的核心服务里面接入了熔断。针对不同的服务，我设计了不同的微服务熔断策略。比如说最简单的熔断策略就是根据响应时间来进行。当响应时间超过阈值一段时间之后就会触发熔断。我一般会根据业务情况来选择这个阈值，例如，如果产品经理要求响应时间是 1s，那么我会把阈值设定在 1.2s。如果响应时间超过 1.2s，并且持续三十秒，就会触发熔断。在触发熔断的情况下，新请求会被拒绝，而已有的请求还是会被继续处理，直到服务恢复正常。
	- >我还设计过一个很有趣的熔断方案。我的一个接口并发很高，对缓存的依赖度非常严重。所以我的熔断策略是要是缓存不可用，比如说 Redis 崩溃了，那么我就会触发熔断。这里如果我在触发熔断之后，我会额外开启一个线程（如果是 Go 就换成 Goroutine）持续不断地 ping Redis。如果 Redis 恢复了，那么我就会退出熔断状态，新来的请求就不会被拒绝了。不熔断的话，请求会因为 Redis 崩溃而全部落到 MySQL 上，基本上会压垮 MySQL。
- **综合了负载均衡算法和熔断措施的方案**
	- 整体思路是利用负载均衡来控制流量。如果一个服务端节点触发了熔断，那么客户端在做负载均衡的时候就可以将这个节点挪出可用列表，后续请求会发给别的节点。在经过一段时间之后，客户端可以尝试发请求给该节点。如果该节点正确处理了，那客户端就可以加大流量。否则客户端就要再一次等待一段时间。
-